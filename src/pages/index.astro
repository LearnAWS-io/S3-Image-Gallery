---
import Layout from "../layout/BasicLayout.astro";
import { getImageUrls } from "../scripts/get-image-urls";

const urls = await getImageUrls();
// console.log(urls);

// console.log(cuteAnimals);
---

<Layout>
  <h1>Hello there my frined</h1>
  {
    urls.map((src) => (
      <img width="200" height="150" src={src} alt="image from heaven" />
    ))
  }
  <form id="file-form">
    <input
      type="file"
      required
      name="file"
      id="file"
      accept="image/jpg, image/png"
    />
    <button type="submit">upload</button>
  </form>
</Layout>

<style is:global>
  h1 {
    font-size: 20px;
  }
  img{
    object-fit: cover
  }
</style>

<script>
  const form = document.getElementById("file-form") as HTMLFormElement;
  const fileEl = document.getElementById("file") as HTMLInputElement;

  const fetchUploadUrl = async () => {
    const res = await fetch("/api/get-upload-url");
    return await res.json();
  };

  const uploadImg = async () => {
    const res = await fetchUploadUrl();
    const formData = new FormData();
    Object.entries(res.fields).forEach((keyval) => {
      //@ts-ignore
      formData.append(...keyval);
    });

    if (fileEl.files === null || fileEl?.files?.length === 0) {
      throw Error("no file present");
    }
    const file = fileEl.files[0];
    formData.append("Content-Type", file.type);
    //make sure to append file at the end
    formData.append("file", file);

    const uploadRes = await fetch(res.url, {
      method: "POST",
      body: formData,
      mode: "cors",
    });

    console.log(uploadRes);

    if (uploadRes.status !== 204) {
      throw Error("Invalid image");
    }
    window.location.reload();
  };

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    uploadImg();
  });
</script>
